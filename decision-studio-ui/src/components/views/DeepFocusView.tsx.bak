import { CouncilDebate } from '../CouncilDebate';

// ... (imports remain the same)

// ... (interface remains the same)

export const DeepFocusView: React.FC<DeepFocusViewProps> = ({
  // ... (props remain the same)
}) => {
  const currentAnalysis = analysisResults;

  // ... (renderVarianceAnalysis remains the same)

  return (
    <div className="min-h-screen bg-slate-950 text-white font-sans flex flex-col">
      {/* ... (Header and Left Column remain the same) ... */}

        {/* RIGHT COLUMN: Action Center (Chat & Debate) */}
        <div className="w-[450px] bg-slate-900 border-l border-slate-800 flex flex-col">
             
             {/* Mode Switcher / Header */}
             <div className="p-4 border-b border-slate-800 bg-slate-900 z-10">
                 <h2 className="text-sm font-bold text-slate-300 uppercase tracking-wider mb-1">
                     Action Center
                 </h2>
                 <p className="text-xs text-slate-500">Refine context and generate solutions</p>
             </div>

             <div className="flex-1 overflow-y-auto p-4 space-y-4">
                 {/* State A: Waiting for Analysis */}
                 {!currentAnalysis && (
                     <div className="flex flex-col items-center justify-center h-64 text-center p-6 opacity-50">
                         <Microscope className="w-12 h-12 text-slate-600 mb-4" />
                         <p className="text-slate-400 text-sm">Run Deep Analysis to unlock problem refinement and solutions.</p>
                     </div>
                 )}

                 {/* State B: Analysis Done, Start Refinement */}
                 {currentAnalysis && !showRefinementChat && !solutions && !findingSolutions && !showPersonaSelector && (
                     <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4">
                         <div className="bg-indigo-900/10 border border-indigo-500/20 rounded-xl p-6 text-center">
                             <Lightbulb className="w-10 h-10 text-indigo-400 mx-auto mb-3" />
                             <h3 className="text-white font-medium mb-2">Refine Problem Statement</h3>
                             <p className="text-sm text-slate-400 mb-4">
                                 Collaborate with the AI to validate hypotheses and set constraints before solving.
                             </p>
                             <button 
                                 onClick={onStartRefinement}
                                 className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-medium transition-colors"
                             >
                                 Start Refinement Session
                             </button>
                         </div>
                     </div>
                 )}

                 {/* State C: Refinement Chat Active */}
                 {showRefinementChat && (
                     <div className="h-full flex flex-col animate-in fade-in">
                         <ProblemRefinementChat 
                             deepAnalysisOutput={{
                                 plan: currentAnalysis.plan || {},
                                 execution: currentAnalysis,
                                 situation_context: {
                                     kpi_name: situation.kpi_name,
                                     description: situation.description,
                                     severity: situation.severity,
                                     situation_id: situation.situation_id
                                 }
                             }}
                             principalContext={principalContext}
                             principalId={principalId}
                             onComplete={onRefinementComplete}
                             onCancel={onRefinementCancel}
                         />
                     </div>
                 )}

                 {/* State D: Persona Selector (Pre-Debate) */}
                 {showPersonaSelector && (
                     <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
                         <div className="flex items-center justify-between mb-2">
                            <h3 className="font-semibold text-white">Assemble Council</h3>
                            <button onClick={() => setShowPersonaSelector(false)} className="text-slate-500 hover:text-white"><X className="w-4 h-4"/></button>
                         </div>

                         {/* Recommended Council */}
                         {refinementResult?.recommended_council_members && refinementResult.recommended_council_members.length > 0 && (
                            <div className="bg-purple-900/20 rounded-lg p-4 border border-purple-500/30">
                                <h4 className="text-xs font-bold text-purple-400 uppercase tracking-wider mb-2">AI Recommendation</h4>
                                <div className="space-y-2 mb-3">
                                    {refinementResult.recommended_council_members.map((m, i) => (
                                        <div key={i} className="text-xs text-slate-300 flex items-center gap-2">
                                            <CheckCircle2 className="w-3 h-3 text-purple-500" />
                                            {m.persona_name}
                                        </div>
                                    ))}
                                </div>
                                <button
                                    onClick={onStartDebate}
                                    className="w-full py-2 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold uppercase rounded transition-colors"
                                >
                                    Convening Recommended Council
                                </button>
                            </div>
                         )}

                         {/* Manual Selection Fallback */}
                         <div className="bg-slate-900 border border-slate-800 rounded-lg p-4">
                             <div className="flex gap-2 mb-4">
                                 <button 
                                     onClick={() => setUseHybridCouncil(false)}
                                     className={`flex-1 py-1.5 text-xs rounded border ${!useHybridCouncil ? 'bg-slate-800 border-white/20 text-white' : 'border-transparent text-slate-500'}`}
                                 >
                                     Internal
                                 </button>
                                 <button 
                                     onClick={() => setUseHybridCouncil(true)}
                                     className={`flex-1 py-1.5 text-xs rounded border ${useHybridCouncil ? 'bg-indigo-600 border-indigo-500 text-white' : 'border-transparent text-slate-500'}`}
                                 >
                                     Hybrid Council
                                 </button>
                             </div>

                             {useHybridCouncil && (
                                 <div className="space-y-2">
                                     {availableCouncils.map(c => (
                                         <button
                                             key={c.id}
                                             onClick={() => setSelectedPreset(c.id)}
                                             className={`w-full text-left p-3 rounded border transition-all ${selectedPreset === c.id ? 'bg-slate-800 border-indigo-500' : 'bg-slate-900/50 border-slate-800 hover:border-slate-700'}`}
                                         >
                                             <div className="flex items-center gap-2">
                                                 <Users className={`w-4 h-4 ${c.color}`} />
                                                 <span className={`text-sm font-medium ${selectedPreset === c.id ? 'text-white' : 'text-slate-300'}`}>{c.label}</span>
                                             </div>
                                         </button>
                                     ))}
                                 </div>
                             )}

                             <button 
                                 onClick={onStartDebate}
                                 className="w-full mt-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-medium flex items-center justify-center gap-2"
                             >
                                 <Users className="w-4 h-4" />
                                 Start Debate
                             </button>
                         </div>
                     </div>
                 )}

                 {/* State E: Debate In Progress */}
                 {findingSolutions && (
                     <div className="animate-in fade-in">
                         <CouncilDebate 
                             phase={debatePhase} 
                             activePersonas={selectedPersonas.length > 0 ? selectedPersonas : (availablePersonas.map(p => p.id).slice(0, 3))} // Fallback if empty
                             availablePersonas={availablePersonas}
                         />
                     </div>
                 )}

                 {/* State F: Solutions (Results) */}
                 {solutions && !findingSolutions && (
                     <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4">
                         <div className="bg-emerald-900/10 border border-emerald-500/20 rounded-xl p-4">
                             <div className="flex items-center gap-2 mb-2">
                                 <CheckCircle2 className="w-5 h-5 text-emerald-400" />
                                 <h3 className="font-semibold text-white">Consensus Reached</h3>
                             </div>
                             <p className="text-sm text-slate-400">
                                 The council has generated {solutions.options_ranked?.length || 0} viable options.
                             </p>
                         </div>

                         {solutions.recommendation && (
                             <div className="bg-slate-800 rounded-lg p-4 border border-slate-700">
                                 <div className="text-xs text-slate-500 uppercase mb-1">Top Recommendation</div>
                                 <div className="text-white font-medium mb-2">{solutions.recommendation.title}</div>
                                 <p className="text-xs text-slate-400 line-clamp-3">{solutions.recommendation_rationale}</p>
                             </div>
                         )}
                         
                         <a 
                             href={`/briefing/${situation.situation_id}`}
                             className="block w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-center rounded-lg font-bold transition-colors"
                         >
                             View Full Decision Briefing
                         </a>
                     </div>
                 )}

             </div>
        </div>
      </div>
    </div>
  );
};
