data_product: FI_Star_Schema
supported_business_processes:
  - "Finance: Profitability Analysis"
  - "Finance: Revenue Growth Analysis"
  - "Finance: Expense Management"
  - "Finance: Cash Flow Management"
  - "Finance: Budget vs. Actuals"
  - "Strategy: Market Share Analysis"
  - "Strategy: EBITDA Growth Tracking"
  - "Strategy: Capital Allocation Efficiency"
  - "Operations: Global Performance Oversight"
  - "Finance: Investor Relations Reporting"
  - "Operations: Order-to-Cash Cycle Optimization"
  - "Operations: Inventory Turnover Analysis"
  - "Operations: Production Cost Management"
  - "Supply Chain: Logistics Efficiency"

# Canonical column aliases for SQL generation
# These remove hardcoded checks in Data Product Agent
column_aliases:
  measure: "Transaction Value Amount"
  date: "Transaction Date"
  version: "Version"
  default_version_value: "Actual"

# Business term mapping for LLM and UI
business_terms:
  region:
    column: customerid
    description: "Customer region, mapped by customerid (example only)"
  profit_center:
    column: profitcenterid
    description: "Profit center, mapped by profitcenterid (example only)"
description: >
  SAP FI Star Schema with explicit schema, kpis:
  # KPIs / Restricted Key Figures) definitions, and table relationships for NLQ/LLM use.

# Default child breakdown dimensions to use when a caller does not specify groupings.
# These business terms are resolved by Data Governance to technical columns.
fallback_group_by_dimensions:
  - product
  - profit_center

views:
  - name: FI_Star_View
    llm_profile:
      exposed_columns:
        - "Profit Center Name"
        - "Customer Type Name"
        - "Customer Name"
        - "Product Name"
        - "Fiscal Year"
        - "Fiscal Quarter"
        - "Fiscal Month"
        - "Fiscal Year-Month"
        - "Account Hierarchy Desc"
        - "Version"
        - "Transaction Value Amount"
      dimension_semantics:
        # Leaf-level dimensions for detailed variance analysis
        - "Profit Center Name"
        - "Customer Type Name"
        - "Customer Name"
        - "Product Name"
        # Time dimensions
        - "Fiscal Year"
        - "Fiscal Quarter"
        - "Fiscal Month"
        - "Fiscal Year-Month"
        # Account dimension (leaf level)
        - "Account Hierarchy Desc"
        # NOTE: Node/Group level dimensions excluded to avoid combining hierarchy levels
        # dimension_hierarchies can be added later for drill-down analysis
    sql: |
      WITH FinancialTransactions_Typed AS (
          SELECT *, strptime(CAST(date AS VARCHAR), '%Y%m%d') AS transaction_date FROM FinancialTransactions
      )
      SELECT
        ft.transactionid AS "Transaction ID",
        EXTRACT(year FROM ft.transaction_date) AS "Fiscal Year",
        EXTRACT(quarter FROM ft.transaction_date) AS "Fiscal Quarter",
        EXTRACT(month FROM ft.transaction_date) AS "Fiscal Month",
        CAST(strftime(ft.transaction_date, '%Y-%m') AS VARCHAR) AS "Fiscal Year-Month",
        strftime(ft.transaction_date, '%W') AS "Fiscal Week",
        CASE WHEN EXTRACT(year FROM ft.transaction_date) = EXTRACT(year FROM CURRENT_DATE) THEN 1 ELSE 0 END AS "Fiscal YTD Flag",
        CASE WHEN EXTRACT(year FROM ft.transaction_date) = EXTRACT(year FROM CURRENT_DATE) AND EXTRACT(quarter FROM ft.transaction_date) = EXTRACT(quarter FROM CURRENT_DATE) THEN 1 ELSE 0 END AS "Fiscal QTD Flag",
        CASE WHEN EXTRACT(year FROM ft.transaction_date) = EXTRACT(year FROM CURRENT_DATE) AND EXTRACT(month FROM ft.transaction_date) = EXTRACT(month FROM CURRENT_DATE) THEN 1 ELSE 0 END AS "Fiscal MTD Flag",
        CASE WHEN ft.transaction_date >= (CURRENT_DATE - INTERVAL '1' YEAR) THEN 1 ELSE 0 END AS "Rolling 12 Months Flag",
        CASE WHEN ft.transaction_date >= (CURRENT_DATE - INTERVAL '4' QUARTER) THEN 1 ELSE 0 END AS "Rolling 4 Quarters Flag",
        ft.accountid AS "Account ID",
        ft.accounttypeid AS "Account Type ID",
        ft.customerid AS "Customer ID",
        ft.customertypeid AS "Customer Type ID",
        ft.productid AS "Product ID",
        ft.productcategoryid AS "Product Category ID",
        ft.profitcenterid AS "Profit Center ID",
        ft.version AS "Version",
        ft.transaction_date AS "Transaction Date",
        CAST(REPLACE(ft.value, ',', '.') AS DECIMAL(18, 2)) AS "Transaction Value Amount",
        gah.DESCRIPTION AS "Account Hierarchy Desc",
        gat."LONG_DESCR" AS "Account Long Description",
        gah.DESCRIPTION AS "Account/Group Description",
        gah.LEVEL AS "Parent Account/Group Hierarchy ID",
        gah_parent.DESCRIPTION AS "Parent Account/Group Description",
        ph.DESCRIPTION AS "Product Name",
        ph.LEVEL AS "Parent Product Hierarchy ID",
        ph_parent.DESCRIPTION AS "Parent Product/Group Description",
        ch.DESCRIPTION AS "Customer Name",
        ch.DESCRIPTION AS "Customer/Group Description",
        ch.LEVEL AS "Parent Customer Hierarchy ID",
        ch_parent.DESCRIPTION AS "Parent Customer/Group Description",
        COALESCE(ctt.LONG_DESCR, ctt.MEDIUM_DESCR, ctt.SHORT_DESCR) AS "Customer Type Name",
        pct.LONG_DESCR AS "Profit Center Name",
        pch.HIERARCHYID AS "Profit Center Hierarchyid",
        ch.HIERARCHYID AS "Customer Hierarchyid",
        pch.DESCRIPTION AS "Profit Center/Group Description",
        pch.LEVEL AS "Parent Profit Center Hierarchy ID",
        pch_parent.DESCRIPTION AS "Parent Profit Center/Group Description"
      FROM FinancialTransactions_Typed ft
      JOIN GLAccounts ga ON ft.accountid = ga.accountid
      LEFT JOIN GLAccountsTexts gat ON ga.accountid = gat.accountid
      LEFT JOIN GLAccountsHierarchy gah ON ga.accountid = gah.HIERARCHYID
      LEFT JOIN GLAccountsHierarchy gah_parent ON gah.LEVEL = gah_parent.HIERARCHYID
      LEFT JOIN Products p ON ft.productid = p.productid
      LEFT JOIN ProductHierarchy ph ON p.productid = ph.HIERARCHYID
      LEFT JOIN ProductHierarchy ph_parent ON ph.LEVEL = ph_parent.HIERARCHYID
      LEFT JOIN Customer c ON ft.customerid = c.customerid
      LEFT JOIN CustomersHierarchy ch ON c.customerid = ch.HIERARCHYID
      LEFT JOIN CustomersHierarchy ch_parent ON ch.LEVEL = ch_parent.HIERARCHYID
      LEFT JOIN CustomerType ct ON ft.customertypeid = ct.customertypeid
      LEFT JOIN CustomerTypeTexts ctt ON ct.customertypeid = ctt.CUSTOMERTYPEID
      LEFT JOIN ProfitCenter pc ON ft.profitcenterid = pc.profitcenterid
      LEFT JOIN ProfitCenterTexts pct ON pc.profitcenterid = pct.PROFITCENTERID
      LEFT JOIN ProfitCenterHierarchy pch ON pc.profitcenterid = pch.HIERARCHYID
      LEFT JOIN ProfitCenterHierarchy pch_parent ON pch.LEVEL = pch_parent.HIERARCHYID

tables:
  - name: GLAccountsHierarchy
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: HIERARCHYID
        type: string
      - name: DESCRIPTION
        type: string
      - name: LEVEL
        type: string

  - name: FinancialTransactions
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: transactionid
        type: string
      - name: date
        type: string
      - name: value
        type: string
      - name: accountid
        type: string
      - name: accounttypeid
        type: string
      - name: customerid
        type: string
      - name: customertypeid
        type: string
      - name: productid
        type: string
      - name: productcategoryid
        type: string
      - name: profitcenterid
        type: string
      - name: version
        type: string

  - name: GLAccountsTexts
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: accountid
        type: string
      - name: account_long_desc
        type: string

  - name: GLAccounts
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: accountid
        type: string
      - name: account_hierarchy_desc
        type: string
      - name: account_name
        type: string

  - name: Products
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: productid
        type: string
      - name: product_name
        type: string

  - name: ProductHierarchy
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: HIERARCHYID
        type: string
      - name: DESCRIPTION
        type: string
      - name: LEVEL
        type: string

  - name: Customer
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: customerid
        type: string
      - name: customer_name
        type: string
      - name: customertypeid
        type: string

  - name: CustomersHierarchy
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: HIERARCHYID
        type: string
      - name: DESCRIPTION
        type: string
      - name: LEVEL
        type: string

  - name: CustomerType
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: customertypeid
        type: string
      - name: type_name
        type: string

  - name: ProductCategories
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: productcategoryid
        type: string
      - name: category_name
        type: string

  - name: ProfitCenter
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: profitcenterid
        type: string
      - name: profitcenter_name
        type: string

  - name: ProfitCenterHierarchy
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: HIERARCHYID
        type: string
      - name: DESCRIPTION
        type: string
      - name: LEVEL
        type: string

  - name: ProfitCenterTexts
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: PROFITCENTERID
        type: string
      - name: LANGUAGE
        type: string
      - name: SHORT_DESCR
        type: string
      - name: MEDIUM_DESCR
        type: string
      - name: LONG_DESCR
        type: string

  - name: CustomerTypeTexts
    data_source_path: 'C:/Users/barry/Documents/Agent 9/SAP DataSphere Data/datasphere-content-1.7/datasphere-content-1.7/SAP_Sample_Content/CSV/FI'
    columns:
      - name: CUSTOMERTYPEID
        type: string
      - name: LANGUAGE
        type: string
      - name: SHORT_DESCR
        type: string
      - name: MEDIUM_DESCR
        type: string
      - name: LONG_DESCR
        type: string

relationships:
  - left_table: FinancialTransactions
    left_column: accountid
    right_table: GLAccounts
    right_column: accountid
    type: many_to_one

  - left_table: FinancialTransactions
    left_column: productid
    right_table: Products
    right_column: productid
    type: many_to_one

  - left_table: FinancialTransactions
    left_column: profitcenterid
    right_table: ProfitCenterHierarchy
    right_column: HIERARCHYID
    type: many_to_one

  - left_table: ProfitCenter
    left_column: profitcenterid
    right_table: ProfitCenterHierarchy
    right_column: HIERARCHYID
    type: many_to_one

  - left_table: Products
    left_column: productcategoryid
    right_table: ProductCategories
    right_column: productcategoryid
    type: many_to_one

  - left_table: FinancialTransactions
    left_column: customerid
    right_table: Customer
    right_column: customerid
    type: many_to_one

  - left_table: Customer
    left_column: customertypeid
    right_table: CustomerType
    right_column: customertypeid
    type: many_to_one

  - left_table: FinancialTransactions
    left_column: profitcenterid
    right_table: ProfitCenter
    right_column: profitcenterid
    type: many_to_one

kpis:
  - name: Gross Revenue
    data_product_id: FI_Star_Schema
    description: "Total gross revenue recognized in the period."
    calculation:
      query_template: 'SUM("[Transaction Value Amount]")'
      filters:
        "Account Hierarchy Desc": "Gross Revenue"
    aggregation: SUM
    base_column: "[Transaction Value Amount]"
    join_tables: ["FI_Star_View"]
    dimensions:
      - "product"
      - "profit_center"
    llm_hints: "Analyzes top-line revenue performance across different business segments."
    business_terms:
      - "Finance: Revenue Growth Analysis"
      - "Strategy: Market Share Analysis"
      - "Operations: Global Performance Oversight"
      - "Finance: Investor Relations Reporting"
    diagnostic_questions:
      - "Which regions are driving the highest gross revenue?"
      - "What is the trend of gross revenue over the last six months?"

  - name: Cost of Goods Sold
    data_product_id: FI_Star_Schema
    description: "Total cost of goods sold in the period."
    calculation:
      query_template: 'SUM("[Transaction Value Amount]")'
      filters:
        "Account Hierarchy Desc": "Cost of Goods Sold"
    aggregation: SUM
    base_column: "[Transaction Value Amount]"
    join_tables: ["FI_Star_View"]
    dimensions:
      - "product"
      - "profit_center"
    business_terms:
      - "Finance: Expense Management"
      - "Operations: Global Performance Oversight"
      - "Finance: Investor Relations Reporting"
    llm_hints: "Measures the direct costs attributable to the production of the goods sold by a company."

  - name: Gross Margin
    data_product_id: FI_Star_Schema
    description: "Gross Margin is calculated as Gross Revenue minus Cost of Goods Sold."
    aggregation: Derived
    formula: "Gross Revenue - Cost of Goods Sold"
    dependencies:
      - "Gross Revenue"
      - "Cost of Goods Sold"
    join_tables: ["FI_Star_View"]
    dimensions:
      - "product"
      - "profit_center"
    business_terms:
      - "Finance: Profitability Analysis"
      - "Strategy: EBITDA Growth Tracking"
      - "Operations: Global Performance Oversight"
      - "Finance: Investor Relations Reporting"
    diagnostic_questions:
      - "What is the actual vs budget for Gross Margin this quarter?"
      - "How does Gross Margin compare to last quarter?"
      - "Which region contributed most to Gross Margin this period?"

  - name: Running Total Gross Revenue
    data_product_id: FI_Star_Schema
    description: "Cumulative sum of Gross Revenue by region and profit center."
    calculation:
      query_template: "SUM([Transaction Value Amount])"
      filters:
        "Account Hierarchy Desc": "Gross Revenue"
    aggregation: SUM
    base_column: "Transaction Value Amount"
    type: window
    base_kpi: Gross Revenue
    window: cumulative
    partition_by: [region, profit_center]
    order_by: [date]
    join_tables: [FI_Star_View]
    business_terms: ["region", "profit_center"]
    dimensions: ["region", "profit_center"]
    llm_hints: "Compute running total of Gross Revenue by region and profit center, ordered by date."
    sql_example: |
      SELECT
        region,
        profit_center,
        date,
        SUM(value) OVER (PARTITION BY region, profit_center ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total_gross_revenue
      FROM FinancialTransactions
      JOIN GLAccounts ON FinancialTransactions.accountid = GLAccounts.accountid
      WHERE GLAccounts.account_hierarchy_desc = 'Gross Revenue'
    diagnostic_questions:
      - "What is the running total of Gross Revenue by region this quarter?"
      - "How does the running total of Gross Revenue compare across profit centers?"

  - name: Top 3 Profit Centers by Gross Revenue
    data_product_id: FI_Star_Schema
    description: "Top 3 profit centers by Gross Revenue for the period."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Gross Revenue'"
    aggregation: SUM
    base_column: "Transaction Value Amount"
    type: top_n
    base_kpi: Gross Revenue
    top_n: 3
    partition_by: [region]
    order_by: ["SUM(value) DESC"]
    join_tables: [FI_Star_View]
    business_terms: ["region", "profit_center"]
    dimensions: ["region", "profit_center"]
    llm_hints: "Return the top 3 profit centers by Gross Revenue within each region."
    sql_example: |
      SELECT
        region,
        profit_center,
        SUM(value) AS gross_revenue,
        ROW_NUMBER() OVER (PARTITION BY region ORDER BY SUM(value) DESC) AS rn
      FROM FinancialTransactions
      JOIN GLAccounts ON FinancialTransactions.accountid = GLAccounts.accountid
      WHERE GLAccounts.account_hierarchy_desc = 'Gross Revenue'
      GROUP BY region, profit_center
      QUALIFY rn <= 3
    diagnostic_questions:
      - "Which are the top 3 profit centers by Gross Revenue this period?"
      - "How does the top profit center's Gross Revenue compare to the others?"

  - name: Sales Deductions
    data_product_id: FI_Star_Schema
    description: "Total sales deductions in the period."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Sales Deductions'"
    filter_type: account_hierarchy_desc
    filter_value: Sales Deductions
    aggregation: SUM
    base_column: "Transaction Value Amount"
    join_tables: [FI_Star_View]
    diagnostic_questions:
      - "What is the actual vs budget for Sales Deductions this quarter?"
      - "How do Sales Deductions compare to last quarter?"
      - "Which region had the highest Sales Deductions this period?"

  - name: Periodic Building Expense
    data_product_id: FI_Star_Schema
    description: "Total periodic building expense."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Periodic Building Expense'"
    filter_type: account_hierarchy_desc
    filter_value: Periodic Building Expense
    aggregation: SUM
    base_column: "Transaction Value Amount"
    diagnostic_questions:
      - "What is the actual vs budget for Periodic Building Expense this quarter?"
      - "How does Periodic Building Expense compare to last quarter?"
      - "Which profit center had the highest Periodic Building Expense?"

  - name: Utilities Expense
    data_product_id: FI_Star_Schema
    description: "Total utilities expense."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Utilities Expense'"
    filter_type: account_hierarchy_desc
    filter_value: Utilities Expense
    aggregation: SUM
    base_column: "Transaction Value Amount"
    join_tables: [FI_Star_View]

  - name: Office Expense
    data_product_id: FI_Star_Schema
    description: "Total office expense."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Office Expense'"
    filter_type: account_hierarchy_desc
    filter_value: Office Expense
    aggregation: SUM
    base_column: "Transaction Value Amount"
    join_tables: [FI_Star_View]

  - name: Payroll
    data_product_id: FI_Star_Schema
    description: "Total payroll expense."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Payroll'"
    filter_type: account_hierarchy_desc
    filter_value: Payroll
    aggregation: SUM
    base_column: "Transaction Value Amount"
    join_tables: [FI_Star_View]

  - name: Travel
    data_product_id: FI_Star_Schema
    description: "Total travel expense."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Travel'"
    filter_type: account_hierarchy_desc
    filter_value: Travel
    aggregation: SUM
    base_column: "Transaction Value Amount"
    join_tables: [FI_Star_View]

  - name: Employee Expense Other
    data_product_id: FI_Star_Schema
    description: "Total employee expense (other)."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Employee Expense Other'"
    filter_type: account_hierarchy_desc
    filter_value: Employee Expense Other
    aggregation: SUM
    base_column: "Transaction Value Amount"
    join_tables: [FI_Star_View]
    diagnostic_questions:
      - "What is the actual vs budget for Employee Expense Other this quarter?"
      - "How does Employee Expense Other compare to last quarter?"
      - "Which profit center had the highest Employee Expense Other?"

  - name: Other Operating Expense
    data_product_id: FI_Star_Schema
    description: "Total other operating expense."
    calculation: "SUM(value) WHERE GLAccounts.account_hierarchy_desc = 'Other Operating Expense'"
    filter_type: account_hierarchy_desc
    filter_value: Other Operating Expense
    aggregation: SUM
    base_column: "Transaction Value Amount"
    join_tables: [FI_Star_View]
    diagnostic_questions:
      - "What is the actual vs budget for Other Operating Expense this quarter?"
      - "How does Other Operating Expense compare to last quarter?"
      - "Which region had the highest Other Operating Expense?"
