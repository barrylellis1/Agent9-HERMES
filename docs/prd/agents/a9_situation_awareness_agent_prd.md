# A9_Situation_Awareness_Agent Product Requirements Document

<!-- 
CANONICAL PRD DOCUMENT
This is the official, canonical PRD document for this agent.
Last updated: 2025-07-17
-->


## 1. Overview

### MVP Channels of Engagement
For MVP, situation communications to principals will be delivered via:
- **Decision Studio UI**: Interactive situation cards in the main UI
- **Gmail notifications**: Email alerts for surfaced situations, leveraging existing Gmail integration

Other communication channels (push notifications, Slack, webhooks, etc.) are planned for future releases.

### 1.1 Purpose
The A9_Situation_Awareness_Agent continuously evaluates all relevant KPIs for a given principal, leveraging data from governance, data product, and principal contexts. Its primary function is to detect, record, and proactively surface significant business situations (such as trends, anomalies, and threshold breaches) and alert the principal or their delegate. The agent aggregates and references outputs from specialized agents (risk, opportunity, stakeholder, etc.) as needed, but does not duplicate their deep analysis logic.

### 1.2 Scope
This document outlines the requirements for version 1.0 of the A9_Situation_Awareness_Agent, focusing on KPI monitoring, situation detection, structured reporting, and registry integration. Deep analysis of risk, opportunity, and stakeholders is delegated to specialized agents, with this agent acting as an orchestrator and aggregator.

### 1.3 Target Audience
- System Administrators
- Business Analysts
- Data Scientists
- Decision Makers

## 2. Business Requirements

### 2.1 Business Objectives
1. Provide real-time detection and surfacing of significant business situations by evaluating all KPIs for a principal
2. Proactively alert principals to anomalies, trends, or threshold breaches using data from governance, product, and context
3. Aggregate and contextualize outputs from specialized agents (risk, opportunity, stakeholder, etc.) without duplicating their logic (delegation only; no deep analysis performed)
4. Generate structured, actionable SituationReports for decision support (no deep analysis or recommendations generated by this agent)

### 2.2 Key Metrics
- Analysis accuracy: > 90% for standard scenarios
- Processing latency: < 2 seconds for small datasets
- System availability: 99.9% uptime
- Error rate: < 1%

## 3. Agent Requirements

### 3.1 Core Agent Interface
- Follow Agent9 agent registry interface requirements
- Implement required registry integration methods
- Use standard error handling patterns
- Maintain consistent logging

### 3.2 Configuration Management
- Support default configuration values
- Validate configuration on initialization
- Maintain configuration state
- Handle agent-specific configuration

### 3.3 Registry Integration
- Support async registration with registry
- Maintain registry reference
- Handle registration errors
- Support registry-based lifecycle management
- Use relative imports for registry integration
- Register with full configuration during registration

### 3.4 Error Handling
- Implement structured error handling
- Log errors appropriately
- Return consistent error responses
- Handle common error types (connection, processing, validation)

### 3.5 Logging
- Initialize agent-specific logger
- Log initialization and major operations
- Support different log levels
- Include timestamps in logs

### 3.6 Core Methods
- Implement _initialize for setup
- Implement _setup_logging for logging
- Implement _setup_error_handling for error management
- Implement register_with_registry for registry integration
- Implement create class method for instance creation

### 3.7 Error Types
- ConfigurationError: Invalid configuration
- RegistrationError: Failed to register with registry
- ProcessingError: Failed to process data
- ValidationError: Invalid input data
- ConnectionError: Connection failures

## 4. Functional Requirements

### 4.1 Situation Analysis

### 4.4 User Interface & Experience (MVP UI)

#### MVP Test Run Limiting (Test Harness Only)
- For each test run, the orchestrator will limit the number of new situations surfaced to 3.
- On each subsequent run, up to 3 additional new situations may be surfaced until all are found.
- This limit is for test/development only and can be adjusted or removed for production.
- The orchestrator tracks which situations have already been surfaced using a persistent Situation List (CSV).
- The UI and CSV will only reflect the situations surfaced in each run.

#### Persistent Situation ID & Attribute Tracking
- Each detected situation is assigned a unique Situation ID (composite key of principal, KPI, geography, product group, time period, etc.).
- All situation attributes are stored with each ID in the persistent Situation List (CSV).
- The orchestrator manages status transitions (new, existing, resolved) and persists all metadata for audit and UI rendering.

- The agent must present surfaced situations as a **card** in the Decision Studio UI.
- Each card must include:
  - **Filters applied**: Principal Context (name/role), Geography, Product Group, Time Period.
  - **KPI Name** (e.g., Revenue, Churn Rate).
  - **Current Value** and **Expected/Plan Value**.
  - **Delta** (difference, color-coded, with up/down arrow).
  - **Status** (New/Existing).
  - **Recognized** (timestamp when first detected).
  - **Deep Analysis Requested** (Yes/No).
  - **Actions**:
    - [Explain This]: LLM-powered plain-language explanation
    - [Annotate]: User comments/notes
    - [Request Deep Analysis]: HITL action to initiate a deeper investigation
  - **Visualization**: Simple bar chart (Current vs. Expected), both bars sharing the same x, y axis.
- The card must be the first swipeable card in the Decision Studio situation flow.
- No complex dashboard or visualization is required for MVP; the focus is on clarity, actionability, and context.

- Context evaluation (deep risk, opportunity, and stakeholder analysis is delegated to specialized agents per Agent9 Agent Design Standards and PRD)
- Trend and anomaly detection (KPI-focused)
- Structured reporting (SituationReport)
- Aggregation of specialized agent outputs (no deep analysis logic performed by this agent)

### 4.2 Data Processing
- Support multiple data sources
- Handle structured and unstructured data
- Perform data validation
- Generate confidence scores

### 4.3 Output Generation
- Generate structured situation reports (SituationReport)
- Provide confidence metrics for anomaly/trend detection
- Include metadata and timestamps
- Output must include all metadata necessary to populate the UI card fields and support filtering, annotation, and HITL actions.
- Deep analysis recommendations are out of scope for MVP and are delegated to specialized agents.

## 5. Technical Requirements

### 5.1 Protocol Compliance Update (2025-06-24)
- All agent entrypoints are orchestrator-driven: no self-registration or direct instantiation.
- Entrypoints accept and emit only protocol-compliant (Pydantic or untyped dict/JSON, as specified) input/output models.
- All logging is async, structured, and uses `A9_SharedLogger`, with event logging awaited in all workflows.
- YAML contract context (`yaml_contract_text`) is always propagated by the orchestrator and accessed via the `context` kwarg in all protocol-compliant methods.
- Registry integration is required for all agent lifecycle events; agent must only store registry reference via `register_with_registry` and never call `register_agent` directly.
- All tests and usage examples must show orchestrator-driven instantiation and registry lifecycle.

## 6. Protocol Compliance

- All agent entrypoints must strictly comply with the A2A protocol, accepting and returning Pydantic models for type safety, validation, and interoperability.
- The agent must implement all MCP (Minimum Compliance Protocol) requirements, including compliance checks, reporting, and error handling.
- Protocol compliance is mandatory for registry integration and agent orchestration.
- This agent is fully compliant with the Agent9 Agent Design Standards and the MVP agent card. See docs/Agent9_Agent_Design_Standards.md and src/agents/new/cards/A9_Situation_Awareness_Agent_card.md for boundaries and protocol details.

### 5.1 System Architecture
- Follow Agent9 architectural principles
- Use standard error handling patterns
- Implement consistent logging
- Support async operations

### 5.2 Implementation
- Use type hints for better maintainability
- Implement proper error handling
- Follow logging best practices
- Support configuration validation

### 5.3 Testing Requirements

#### 5.3.1 Core Tests
- Verify agent registration
- Test configuration validation
- Check error handling
- Validate logging
- Test async operations

#### 5.3.2 Test Fixtures
- Use real registry instance
- Provide valid and invalid configurations
- Test edge cases
- Verify error states

#### 5.3.3 Test Cases
- Agent initialization
- Registry integration
- Situation analysis (KPI monitoring, anomaly/trend detection, reporting)
- Error handling
- Logging
- Performance
- Ensure no deep analysis, recommendations, or impact calculation logic is present in test expectations (these are delegated to specialized agents)

## 6. Modification History

### 6.1 Current Version
- Version: 1.0
- Date: [Release Date]
- Changes: Initial implementation
- Affected Test Cases: All

### 6.2 Planned Modifications

## 7. Implementation Details

### 7.1 Notification System
- Implements email notification functionality using Gmail client integration
- Provides configurable notification templates for different situation types
- Supports customizable alert thresholds and notification frequency
- Includes email formatting for improved readability and action items

### 7.2 User Preferences
- Implements static user preferences system for notification settings
- Provides methods for retrieving and applying user-specific thresholds
- Supports customization of situation detection sensitivity
- Includes preference persistence across sessions

### 7.3 Prompt Generation
- Implements deep dive prompt generation method for detailed situation analysis
- Provides structured templates for consistent prompt formatting
- Supports context-aware prompt customization based on situation type
- Includes metadata enrichment for improved analysis quality

### 7.4 Agent Integration
- Implements explicit agent integration workflow in run_situation_check
- Provides standardized interfaces for inter-agent communication
- Supports orchestrator-driven agent collaboration
- Includes context propagation between agent interactions

### 7.5 Context Validation
- Implements explicit context validation logic for input verification
- Provides robust error handling for invalid or incomplete context
- Supports graceful degradation when context is partially available
- Includes logging of context validation results for debugging

#### 6.2.1 Registry Integration Improvements
- Purpose: Enhance registry integration and module structure
- Impact Analysis:
  - Input Changes: None
  - Output Changes: None
  - Data Flow Changes: Changed registry registration flow to use relative imports and simplify agent creation
- Test Impact:
  - Affected Test Cases: Registry integration tests, agent creation tests
  - New Test Cases Needed: None
  - Test Data Changes: None
- Implementation Plan:
  1. Update imports to use relative paths instead of absolute paths
  2. Simplify agent creation process by removing redundant creation methods
  3. Enhance registry registration to include full configuration
  4. Update test cases to reflect new structure
- Documentation Updates:
  - [ ] Update registry integration documentation
  - [ ] Update agent creation documentation
  - [ ] Update error handling documentation
  - [ ] Update usage examples
  - [ ] Update configuration documentation

#### 6.2.2 Error Handling Improvements
- Purpose: Enhance error handling and logging
- Impact Analysis:
  - Input Changes: None
  - Output Changes: Enhanced error responses
  - Data Flow Changes: Improved error propagation
- Test Impact:
  - Affected Test Cases: Error handling tests
  - New Test Cases Needed: Additional error scenarios
  - Test Data Changes: None
- Implementation Plan:
  1. Review and update error types
  2. Enhance error propagation
  3. Improve logging
  4. Add new test cases
- Documentation Updates:
  - [ ] Update error handling documentation
  - [ ] Update logging documentation
  - [ ] Update test documentation

## 7. Acceptance Criteria

### 7.0 Protocol Compliance (2025-06-24)
- All surfaced situations show context derived from YAML contract and principal context.
- All actions (explain, annotate, request deep analysis) trigger orchestrator-driven workflows.
- No legacy or direct agent instantiation patterns allowed in UI or backend.
- All tests invoke the agent via the orchestrator and assert on event logs using public APIs.
- Documentation and usage examples reflect orchestrator-driven instantiation and registry lifecycle.

### 7.1 Functional

### 7.3 UI/UX Acceptance Criteria (MVP UI)
- [ ] Card displays all required fields (filters, KPI, values, delta, status, timestamp, deep analysis status).
- [ ] Bar chart accurately visualizes Current vs. Expected KPI on the same axes.
- [ ] [Request Deep Analysis] button is present and triggers a HITL workflow.
- [ ] [Explain This] and [Annotate] actions are available and functional.
- [ ] Card layout is clear, compact, and actionable, with context filters always visible.
- [ ] No extraneous data or visual clutter is present in the MVP.

- Successful registry integration
- Accurate situation analysis
- Proper error handling
- Complete documentation

### 7.2 Non-Functional
- Performance meets requirements
- Error handling is robust
- Logging is comprehensive
- Documentation is complete

## 8. Maintenance and Support

### 8.1 Maintenance
- Regular updates
- Security patches
- Performance optimization
- Documentation updates

### 8.2 Support
- User documentation
- API documentation
- Troubleshooting guide
- Support channels



## Hackathon Quick Start

### Development Environment Setup
- Clone the Agent9-Hackathon-Template repository
- Install required dependencies from requirements.txt
- Configure environment variables in .env file based on .env.template

### Key Files and Entry Points
- Main agent implementation: `src/agents/new/A9_Situation_Awareness_Agent_Agent.py`
- Configuration model: `src/agents/new/agent_config_models.py`
- Agent card: `src/agents/new/cards/a9_situation_awareness_agent_agent_card.py`

### Test Data Location
- Sample data available in `test-data/` directory
- Test harnesses in `test-harnesses/` directory

### Integration Points
- Integrates with Agent Registry for orchestration
- Follows A2A protocol for agent communication
- Uses shared logging utility for consistent error reporting

## Implementation Guidance

### Suggested Implementation Approach
1. Start with the agent's core functionality
2. Implement required protocol methods
3. Add registry integration
4. Implement error handling and logging
5. Add validation and testing

### Core Functionality to Focus On
- Protocol compliance (A2A)
- Registry integration
- Error handling and logging
- Proper model validation

### Testing Strategy
- Unit tests for core functionality
- Integration tests with mock registry
- End-to-end tests with test harnesses

### Common Pitfalls to Avoid
- Direct agent instantiation (use registry pattern)
- Missing error handling
- Incomplete logging
- Improper model validation

## Success Criteria

### Minimum Viable Implementation
- Agent implements all required protocol methods
- Agent properly integrates with registry
- Agent handles errors and logs appropriately
- Agent validates inputs and outputs

### Stretch Goals
- Enhanced error handling and recovery
- Performance optimizations
- Additional features from Future Enhancements section

### Evaluation Metrics
- Protocol compliance
- Registry integration
- Error handling
- Logging quality
- Input/output validation

---

## References

- [Persona Debate Meeting Minutes – Situation Awareness MVP (2025-04-20)](../meetings/a9_situation_awareness_mvp_persona_debate_2025-04-20.md)
- [Situation Awareness Agent Wireframe – Decision Studio Card UI](/docs/prd/agents/a9_situation_awareness_agent_wireframe.md)

## Change Log

- **2025-04-20:** Updated MVP requirements and action items based on Windsurf persona debate. See [meeting minutes](../meetings/a9_situation_awareness_mvp_persona_debate_2025-04-20.md) for details.

- User documentation
- API documentation
- Troubleshooting guide
- Support channels
